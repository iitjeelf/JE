<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LFJC Online Exam</title>

<style>
/* Your original CSS exactly as-is */
body{font-family:"SF Pro Display",Arial,sans-serif;margin:0;background:#fff;color:#000;}
header{background:linear-gradient(145deg,#E6E6FA,#D8BFD8);color:#4B0082;text-align:center;padding:20px;font-size:36px;font-weight:700;letter-spacing:1.5px;box-shadow:0 5px #aaa;text-shadow:0 1px 2px #fff;}
#studentEntry,#examArea{padding:16px;text-align:center;}
#studentEntry{display:flex;flex-direction:column;justify-content:center;align-items:center;min-height:calc(100vh - 140px);}
.form-group{display:flex;flex-direction:row;align-items:center;justify-content:center;margin-bottom:60px;}
.form-group label{font-size:1.15rem;font-weight:600;margin-right:10px;color:#4B0082;width:120px;text-align:right;}
input[type="text"]{padding:10px 12px;font-size:1.1rem;border-radius:10px;border:1.5px solid #4B0082;outline:none;min-width:250px;}
input.error{animation:glowRed 0.5s alternate infinite;border-color:red;}
@keyframes glowRed{0%{box-shadow:0 0 5px red;}100%{box-shadow:0 0 15px red;}}
button{position:relative;overflow:hidden;cursor:pointer;border:none;border-radius:12px;transition:all .18s ease;box-shadow:0 6px #aaa;background:linear-gradient(to bottom,#fafaff,#dcd6f7);color:#4B0082;font-weight:600;padding:10px 20px;font-size:18px;}
button:hover{transform:translateY(-2px);box-shadow:0 8px 15px rgba(0,0,0,.28);}
button:active{transform:translateY(3px) scale(.98);}
.optBtn{font-size:16px;padding:8px 18px;margin:6px;border:2px solid #4B0082;background:#fff;border-radius:8px;box-shadow:0 5px #aaa;}
.optBtn.selected{background:#32CD32;color:#fff;border-color:#2fa92f;}
.navContainer{display:flex;justify-content:center;gap:10px;margin:10px 0;flex-wrap:wrap}
.navBtn{font-size:16px;padding:10px 20px;border-radius:8px;color:#fff;font-weight:bold;cursor:pointer;background:linear-gradient(145deg,#1E90FF,#4682B4);}
#markReviewBtn{background:linear-gradient(145deg,#ffb84d,#ff9900)}
#submitBtn{background:linear-gradient(145deg,#c8b88a,#b49e60)}
#timerEl{font-size:20px;font-weight:bold;color:#4B0082;padding:6px 12px;border-radius:6px;background:#f0f0ff;display:inline-block;transition: all 0.3s ease;}
#timerEl.blink{animation:blinkTimer 1s infinite;}
@keyframes blinkTimer{0%{background:#ff6666;color:#fff;}50%{background:#fff;color:#4B0082;}100%{background:#ff6666;color:#fff;}}
#paletteContainer button{width:36px;height:36px;border-radius:50%;font-size:14px;margin:3px;border:1px solid #4B0082;background:#E6E6FA;color:#4B0082;}
#paletteContainer button.selected{background:#32CD32;color:#fff;border-color:#2fa92f}
#paletteContainer button.reviewed{background:yellow;color:#000}
#paletteContainer button.current{border:3px solid red}
footer{background:#E6E6FA;color:#4B0082;padding:10px;text-align:center;font-weight:bold;position:fixed;width:100%;bottom:0;}
.sectionTitle{font-size:22px;color:#4B0082;font-weight:bold;margin-bottom:8px;}
img.questionImg{max-width:100%;border-radius:10px;}
.glow {animation: glowPulse 1.6s infinite alternate;box-shadow:0 8px 18px rgba(75,0,130,0.12);}
@keyframes glowPulse{0% { box-shadow:0 6px 10px rgba(75,0,130,0.06); transform:translateY(0); } 50% { box-shadow:0 12px 30px rgba(75,0,130,0.14); transform:translateY(-2px); } 100% { box-shadow:0 6px 10px rgba(75,0,130,0.06); transform:translateY(0); }}

#fullRedOverlay{ position:fixed; left:0; top:0; width:100%; height:100%; display:none; background:red; z-index:9999; pointer-events:auto; }
#accessDeniedBox{ position:fixed; left:50%; top:40%; transform:translate(-50%,-50%); z-index:10000; color:#fff; text-align:center; display:none; pointer-events:auto; }
#accessDeniedBox h1{ font-size:48px; font-weight:900; margin:0 0 18px 0; color:#fff; text-shadow:0 2px 6px rgba(0,0,0,0.4); }
#callAdminBtn{ padding:12px 22px; border-radius:12px; font-weight:800; }

.confirmModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:10001;}
.confirmBox{background:#fff;padding:20px;border-radius:12px;min-width:280px;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,0.3);}
.confirmBox p{font-size:18px;color:#4B0082;margin-bottom:15px;}
.confirmBox button{margin:0 10px;padding:8px 16px;font-size:16px;cursor:pointer;}

@media(max-width:600px){
  #accessDeniedBox h1{font-size:28px;}
  #callAdminBtn{padding:10px 14px;}
  .form-group{flex-direction:column;align-items:flex-start;}
  .form-group label{text-align:left;width:auto;margin-bottom:5px;}
}

#stuInfo { text-align: left !important; white-space:nowrap; }
</style>
</head>

<body>

<header>LFJC ONLINE EXAMINATION</header>

<div id="studentEntry">
  <div class="form-group"><label>NAME</label><input type="text" id="stuName"></div>
  <div class="form-group"><label>SECTION</label><input type="text" id="stuSection"></div>
  <div class="form-group"><label>ROLL NUMBER</label><input type="text" id="stuRoll"></div>
  <div class="form-group"><label>ADMISSION NUMBER</label><input type="text" id="stuAdm"></div>
  <div class="form-group"><button id="stuStartBtn" style="display:none;">Start Exam</button></div>
</div>

<div id="examArea" style="display:none;">
  <div id="examHeader">
    <div id="stuInfo"></div>
    <div id="stuQInfo"></div>
    <div><span id="timerEl">ðŸ•’ 00:00</span></div>
  </div>

  <div id="questionContainer"></div>

  <div class="navContainer">
    <button class="navBtn" id="prevBtn">â¬… Previous</button>
    <button class="navBtn" id="markReviewBtn">Review</button>
    <button class="navBtn" id="nextBtn">Next âž¡</button>
    <button class="navBtn" id="submitBtn">Submit Exam</button>
  </div>

  <div id="paletteContainer"></div>
</div>

<footer>LFJC@2025 All rights reserved</footer>

<script>
/* ------------------------- CONFIG -------------------------- */
const SHEET_URL = "https://script.google.com/macros/s/AKfycbz1DVbfKyBz1Q8QMrhJOwUK3maEqXyrL50A4cGLmcIzfNO8VVGT3oSJ651laosOgCAm/exec";
const MARK_PER_CORRECT = 1;
const MARK_PER_WRONG = -0.25;

let images = [...Array(50)].map((_,i)=>`${i+1}.png`);
let answerKey = [..."ABCD".repeat(13).slice(0,50)];
const subjects = ["Maths","Physics","Chemistry"];

let examData = { files:[], subjectNames:[], keys:[] };
let progress = null;
let timerInterval = null;

/* ---------------------- HELPERS ---------------------------- */

function shuffleArray(arr){
  arr = arr.slice();
  for(let i=arr.length-1;i>0;i--){
    let j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

/* Split images among subjects */
function prepareExamData(){
  examData.files=[];
  examData.keys=[];
  examData.subjectNames=[];

  const total = images.length;
  const base = Math.floor(total/3);
  let rem = total % 3;
  let start = 0;
  let groups = [];

  for(let s=0;s<3;s++){
    const count = base + (rem>0?1:0);
    rem--;

    const imgs = images.slice(start,start+count);
    const keys = answerKey.slice(start,start+count);

    start += count;

    const idx = shuffleArray([...Array(imgs.length).keys()]);

    groups.push({
      name: subjects[s],
      imgs: idx.map(i=>imgs[i]),
      keys: idx.map(i=>keys[i])
    });
  }

  shuffleArray(groups).forEach(g=>{
    g.imgs.forEach((img,i)=>{
      examData.files.push(img);
      examData.keys.push(g.keys[i]);
      examData.subjectNames.push(g.name);
    });
  });
}

function validateStudentInputs(){
  const n = stuName.value.trim();
  const s = stuSection.value.trim();
  const r = stuRoll.value.trim();
  const a = stuAdm.value.trim();

  let v1=/^[A-Za-z .]+$/.test(n);
  let v2=/^[A-Za-z0-9]+$/.test(s);
  let v3=/^[0-9]+$/.test(r);
  let v4=/^[0-9]+$/.test(a);

  stuStartBtn.style.display = (v1 && v2 && v3 && v4) ? "inline-block" : "none";
}

["stuName","stuSection","stuRoll","stuAdm"].forEach(id=>{
  document.getElementById(id).addEventListener("input",validateStudentInputs);
});

/* ------------------------- START ---------------------------- */

stuStartBtn.onclick = () => {
  startExam();
};

function startExam(){
  prepareExamData();

  progress = {
    answers: Array(examData.files.length).fill(null),
    review: Array(examData.files.length).fill(false),
    currentIndex: 0,
    student: {
      name: stuName.value,
      sec: stuSection.value,
      roll: stuRoll.value,
      adm: stuAdm.value,
    },
    timeLeftSec: 5 * 60
  };

  studentEntry.style.display="none";
  examArea.style.display="block";

  renderQuestion();
  renderPalette();
  updateNavButtons();
  startTimer();
}

/* ------------------------- TIMER ---------------------------- */

function startTimer(){
  timerInterval=setInterval(()=>{
    if(progress.timeLeftSec <= 0){
      clearInterval(timerInterval);
      submitExam();
      return;
    }

    progress.timeLeftSec--;

    let m=Math.floor(progress.timeLeftSec/60);
    let s=progress.timeLeftSec%60;

    timerEl.textContent=`ðŸ•’ ${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;

    stuInfo.textContent = `${progress.student.name} | ${progress.student.sec} | ${progress.student.roll} | ${progress.student.adm}`;
    stuQInfo.textContent = `${examData.subjectNames[progress.currentIndex]} | Q ${progress.currentIndex+1}/${examData.files.length}`;
  },1000);
}

/* ------------------------- RENDER QUESTION ---------------------------- */

function renderQuestion(){
  const i = progress.currentIndex;

  questionContainer.innerHTML = `
    <img src="${examData.files[i]}" class="questionImg">
    <br><br>
  `;

  const optsDiv = document.createElement("div");

  ["A","B","C","D"].forEach(opt=>{
    const b=document.createElement("button");
    b.className="optBtn";
    b.textContent=opt;

    if(progress.answers[i]===opt) b.classList.add("selected");

    b.onclick=()=>{
      progress.answers[i] = (progress.answers[i]===opt ? null : opt);
      renderQuestion();
      renderPalette();
    };

    optsDiv.appendChild(b);
  });

  questionContainer.appendChild(optsDiv);
}

/* ------------------------- NAVIGATION ---------------------------- */

prevBtn.onclick=()=>{
  if(progress.currentIndex>0){
    progress.currentIndex--;
    renderQuestion();
    renderPalette();
    updateNavButtons();
  }
};

nextBtn.onclick=()=>{
  if(progress.currentIndex<examData.files.length-1){
    progress.currentIndex++;
    renderQuestion();
    renderPalette();
    updateNavButtons();
  }
};

markReviewBtn.onclick=()=>{
  progress.review[progress.currentIndex] = !progress.review[progress.currentIndex];
  markReviewBtn.textContent = progress.review[progress.currentIndex] ? "Unreview" : "Review";
  renderPalette();
};

function updateNavButtons(){
  prevBtn.style.display = progress.currentIndex===0 ? "none":"inline-block";
  nextBtn.style.display = progress.currentIndex===examData.files.length-1 ? "none":"inline-block";
  markReviewBtn.textContent = progress.review[progress.currentIndex] ? "Unreview" : "Review";
}

/* ------------------------- PALETTE ---------------------------- */

function renderPalette(){
  paletteContainer.innerHTML = "";
  paletteContainer.style.display="grid";
  paletteContainer.style.gridTemplateColumns="repeat(20,1fr)";

  progress.answers.forEach((ans,i)=>{
    const b=document.createElement("button");
    b.textContent = i+1;

    if(progress.review[i]) b.classList.add("reviewed");
    if(i===progress.currentIndex) b.classList.add("current");
    if(ans) b.classList.add("selected");

    b.onclick=()=>{
      progress.currentIndex = i;
      renderQuestion();
      renderPalette();
      updateNavButtons();
    };

    paletteContainer.appendChild(b);
  });
}

/* ------------------------- SEND TO SHEET ---------------------------- */

function sendToSheet(data){
  fetch(SHEET_URL,{
    method:"POST",
    mode:"no-cors",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(data)
  });
}

/* ------------------------- SUBMIT EXAM ---------------------------- */

submitBtn.onclick = () => submitExam();

function submitExam(){
  clearInterval(timerInterval);

  const subjData = {};
  let totalCorrect = 0, totalWrong=0, totalBlank=0, totalQs=0;

  examData.subjectNames.forEach((subj,i)=>{
    if(!subjData[subj])
      subjData[subj] = {correct:0,wrong:0,blank:0,total:0};

    const ans = progress.answers[i];
    const key = examData.keys[i];

    if(ans === null) subjData[subj].blank++;
    else if(ans === key) subjData[subj].correct++;
    else subjData[subj].wrong++;

    subjData[subj].total++;
  });

  for(let s in subjData){
    totalCorrect += subjData[s].correct;
    totalWrong += subjData[s].wrong;
    totalBlank += subjData[s].blank;
    totalQs += subjData[s].total;
  }

  let marks = (totalCorrect * MARK_PER_CORRECT) + (totalWrong * MARK_PER_WRONG);

  /* FIXED BLOCK â€” no more crash */
  sendToSheet({
    name: progress.student.name,
    section: progress.student.sec,
    roll: progress.student.roll,
    adm: progress.student.adm,
    correct: totalCorrect,
    wrong: totalWrong,
    blank: totalBlank,
    total: totalQs,
    marks: marks,
    answers: progress.answers
  });

  examArea.innerHTML = `
    <h2 style="color:#4B0082;">ðŸŽ‰ Congratulations, ${progress.student.name}</h2>
    <p><b>Section:</b> ${progress.student.sec} | <b>Roll:</b> ${progress.student.roll} | <b>Admission:</b> ${progress.student.adm}</p>

    <table border="1" style="width:95%;margin:auto;border-collapse:collapse;">
      <tr style="background:#E6E6FA;">
        <th>Subject</th><th>Correct</th><th>Wrong</th><th>Blank</th><th>Total</th><th>%</th>
      </tr>
  `;

  for(let s in subjData){
    let v=subjData[s];
    let per=((v.correct/v.total)*100).toFixed(2);
    examArea.innerHTML += `
      <tr>
        <td>${s}</td>
        <td>${v.correct}</td>
        <td>${v.wrong}</td>
        <td>${v.blank}</td>
        <td>${v.total}</td>
        <td>${per}%</td>
      </tr>
    `;
  }

  let totalPer = ((totalCorrect/totalQs)*100).toFixed(2);

  examArea.innerHTML += `
      <tr style="background:#D8BFD8;font-weight:bold;">
        <td>Total</td>
        <td>${totalCorrect}</td>
        <td>${totalWrong}</td>
        <td>${totalBlank}</td>
        <td>${totalQs}</td>
        <td>${totalPer}%</td>
      </tr>
    </table>
    <br>
    <button onclick="location.reload()" class="glow">Logout</button>
  `;
}

</script>

</body>
</html>
